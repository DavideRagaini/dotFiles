# ---------- Profile Import ----------
include='~~/flake.conf'

# ---------- General ----------
load-stats-overlay=yes
save-position-on-quit=yes
msg-module
msg-color
term-osd-bar
use-filedir-conf
prefetch-playlist=yes
osc=no
hls-bitrate=min
drag-and-drop=append

# ---------- Window ----------
hdr-compute-peak=no
keep-open=yes
cursor-autohide=1000
force-window=immediate

# ---------- Audio ----------
volume=100
volume-max=150
alang=ja,jp,jpn,en,eng,english,fr,fre,french,de,deu,ger,german,it,ita,italian

# ---------- Video ----------
deband=no
deband-iterations=4
deband-grain=48

# ---------- Cache/Demuxer ----------
cache=yes
cache-pause-initial=yes
cache-pause-wait=2
stream-buffer-size=512KiB

# ---------- Subtitles ----------
sid=no
sub-auto=all
sub-file-paths-append=ass:srt:sub:subs:subtitles
slang=enGB,en-GB,en,eng,english,English,enUS,en-US,en-orig,en-en,enm,it,ita,italian,de,deu,ger,unknown,und,mis,mul,zxx
# subs-with-matching-audio=yes
# sub-font=RobotoMono Nerd Font Propo SemiBold
# sub-font-size=30
# sub-ass-force-style=FontName=RobotoMono Nerd Font Propo Bold
# sub-margin-y=30
sub-ass-override=no
sub-font="Gandhi Sans"
sub-font-size=50
sub-color="#FFFFFF"
sub-border-size=2.4
sub-border-color="#FF000000"
sub-shadow-color="#A0000000"
sub-shadow-offset=0.75
sub-bold=yes

# ---------- Playback ----------
reset-on-next-file=pause,aid,audio-delay,sub-delay,video-aspect-override,video-pan-x,video-pan-y,video-rotate,video-zoom,contrast,gamma,saturation,hue,sub-visibility,ontop,deinterlace,vf,brightness,secondary-sid
watch-later-options-remove=pause
watch-later-options-remove=contrast
watch-later-options-remove=mute
watch-later-options-remove=fullscreen
watch-later-options-remove=ontop
watch-later-options-remove=sub-pos
watch-later-options-remove=deinterlace
watch-later-options-remove=af
watch-later-options-remove=vf
watch-later-options-remove=brightness
no-hidpi-window-scale

# ---------- Keys ----------
native-keyrepeat=yes
input-ar-delay=500
input-ar-rate=20
input-right-alt-gr=no

# ---------- OSD ----------
osd-margin-x=0
osd-margin-y=0
osd-font='Fantasque Sans Mono'
osd-font-size=20
# osd-msg1='${osd-sym-cc} ${playback-time} / ${duration} ${percent-pos}%'
osd-msg2="${playback-time/full}/${duration/full}(${percent-pos}%)\nframe:${estimated-frame-number}/${estimated-frame-count}"
osd-msg3='${osd-sym-cc} ${time-pos} / ${duration} (${percent-pos}%) [${playtime-remaining}] [${demuxer-cache-duration}] (${speed})'

# ---------- Screenshot ----------s
screenshot-template='~/Screenshots/%F - [%P]v%#01n %n'

# ---------- Script Options ----------
script-opts=ytdl_hook-try_ytdl_first=yes,ytdl_hook-exclude="%.webm$|%.ts$|%.mp3$|%.m3u8$|%.m3u$|%.mkv$|%.mp4$|%.VOB$"

# ---------- Profiles ----------
[dgpu]
vo=gpu-next
hwdec=auto-safe

[high-memory]
cache-secs=600
demuxer-max-bytes=500MiB
demuxer-max-back-bytes=75MiB

[low-memory]
cache-secs=360
demuxer-max-bytes=100MiB
demuxer-max-back-bytes=75MiB

[hq]
profile-cond=((p["video-params/w"]>=1920 and p["video-params/h"]>=900))
profile-restore=copy
scale=ewa_lanczos
cscale=ewa_lanczos
dscale=catmull_rom
scale-antiring=0.5
dscale-antiring=0.5
linear-upscaling=no
dither-depth=auto
hdr-contrast-recovery=0.30
correct-downscaling=yes
linear-downscaling=yes
sigmoid-upscaling=yes
deband=no
video-sync=display-resample
# icc-profile-auto

[mid]
scale=lanczos
cscale=lanczos
dscale=mitchell
dither-depth=auto
correct-downscaling=yes
linear-downscaling=yes
sigmoid-upscaling=yes
hdr-compute-peak=yes
scale-antiring=0.6
deband=no
# dither-depth = 8 # monitor's bit depth

[lq]
profile-cond=((p["video-params/w"]<=1280 and p["video-params/h"]<=720))
profile-restore=copy
profile=sw-fast
gpu-dumb-mode=yes
scale=bilinear
cscale=bilinear
dscale=bilinear
dither=no
correct-downscaling=no
linear-downscaling=no
sigmoid-upscaling=no
hdr-compute-peak=no
video-latency-hacks=yes
video-sync=audio
vd-lavc-dr=no
vd-lavc-fast
vd-lavc-skiploopfilter=nonkey
vd-lavc-skipframe=nonkey
vd-lavc-framedrop=nonkey
vd-lavc-threads=2

[cinecave]
profile-restore=copy
profile=surround
profile=hq
script="~~/script-optionals/channel_mixer.lua"
slang=it,ita,italian,enGB,en-GB,en,eng,english,English,enUS,en-US,en-orig,en-en,enm,fr,fre,french,de,deu,ger,german,unknown,und,mis,mul,zxx
sid=auto

[dash-best]
ytdl-format=bestvideo+bestaudio/best
demuxer-max-bytes=1GiB

[dash-high]
# profile-cond=path:match('') ~= nil
ytdl-format=bestvideo[height<=?1080]+bestaudio/best
demuxer-max-bytes=600MiB

[dash-mid]
ytdl-format=bestvideo[height<=?720][fps<=?30][vcodec~='^(avc|h264)'][vcodec!=?vp9][protocol!=http_dash_segments]+bestaudio/best
demuxer-max-bytes=300MiB

[dash-low]
ytdl-format=bestvideo[height<=?480][fps<=?30][vcodec~='^(avc|h264)'][vcodec!=?vp9][protocol!=http_dash_segments]+bestaudio/best

[stream-high]
profile=low-latency

[stream-mid]
ytdl-format=bestvideo[height<=?720][fps<=?30][vcodec!=?vp9]+bestaudio/best[height<=?720][fps<=?30]

[stream-low]
ytdl-format=bestvideo[height<=?480][fps<=?30][vcodec!=?vp9]+bestaudio/best[height<=?480][fps<=?30]
demuxer-max-bytes=8192

[dont-save-pos-for-short-videos]
profile-cond=duration <= 300
profile-restore=copy
save-position-on-quit=no

[shorter-then-45m]
profile-cond=duration <= 2700 and duration > 300
profile=dash-high
profile=hq

[longer-then-45m]
profile-cond=duration > 2700
profile=lq
osd-level=3

[films]
profile-cond=((p["video-params/w"]==1920 and p["video-params/h"]<=1080) and p["estimated-vf-fps"]<=24 and require 'mp.utils'.join_path(working_directory, path):match('Videos') ~= nil)
profile=hq
deband=yes
sid=auto
osd-level=0

[notfullscreen]
profile-cond=vid and vo_configured and not fullscreen and not get("current-tracks/video/albumart")
profile-restore=copy
video-sync=display-resample

# [unfocused]
# profile-cond=not p["focused"] and not p["ontop"]
# profile-restore=copy
# window-minimized=yes

# [focused]
# profile-cond=p["focused"] and p["ontop"] and p["audio-params/format"] ~= nil
# profile-restore=copy
# window-minimized=no

# ---------- Protocols ----------
[protocol.https]
user-agent='Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/118.0.0.0 Safari/537.36'
network-timeout=30
tls-verify=yes
stream-lavf-o-append=multiple_requests=1

[protocol.http]
profile=protocol.https

[protocol.file]
profile-desc=Allow seeking in incomplete local files
force-seekable=yes

[extension.gif]
profile-desc=GIF
cache=no
no-pause
loop-file=yes

[extension.png]
profile-desc=PNG
video-aspect-override=no
loop-file=yes

[extension.jpg]
profile-desc=JPG
video-aspect-override=no
loop-file=yes

[extension.jpeg]
profile-desc=JPEG
profile=extension.jpg

# ---------- Surround ----------
# https://blogs.gentoo.org/mgorny/2021/07/25/getting-dts-5-1-sound-via-s-pdif-or-hdmi-using-pulseaudio/
[surround]
audio-channels=7.1,5.1,stereo
audio-spdif=ac3,dts-hd,dts,truehd,eac3
af=lavcac3enc=yes:auto:3 # =yes:640:3
# af=drc=2
# af=lavfi=[dynaudnorm=g=5:f=250:r=0.9:p=0.5]
# af=dynaudnorm=f=400:g=5:m=4:p=0.95:t=0
# af=lavfi=[loudnorm=I=-16:TP=-3:LRA=4]
# af=pan="stereo|FL=0.707*FC+0.3*FL+0.1*BL+0.1*LFE|FR=0.707*FC+0.3*FR+0.1*BR+0.1*LFE"
# compand=0|0:1|1:-90/-900|-70/-70|-30/-9|0/-3:6:0:0:0
# af="pan=stereo|FL < 0.622FL+0.792FC+0.283BL+0.283SL+0.14LFE|FR < 0.622FR+0.792FC+0.283BR+0.283SR+0.14LFE,dynaudnorm=p=1/sqrt(2):m=100:s=20"
# af="pan=stereo|FL=0.5*FC+0.707*FL+0.707*BL+0.5*LFE|FR=0.5*FC+0.707*FR+0.707*BR+0.5*LFE,loudnorm=I=-16:TP=-3:LRA=4"
